name: üöÄ Deploy to EC2

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      setup_new:
        description: 'First time EC2 setup?'
        required: false
        default: 'false'
        type: boolean

jobs:
  check-secrets:
    runs-on: ubuntu-latest
    timeout-minutes: 2
    steps:
    - name: üîç Validate GitHub Secrets
      run: |
        echo "üîç Checking GitHub Secrets..."
        
        MISSING_SECRETS=()
        
        if [ -z "${{ secrets.EC2_HOST }}" ]; then
          MISSING_SECRETS+=("EC2_HOST")
        fi
        
        if [ -z "${{ secrets.EC2_USER }}" ]; then
          MISSING_SECRETS+=("EC2_USER")
        fi
        
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          MISSING_SECRETS+=("SSH_PRIVATE_KEY")
        fi
        
        if [ ${#MISSING_SECRETS[@]} -eq 0 ]; then
          echo "‚úÖ All required secrets are configured!"
          echo "‚úÖ EC2_HOST: ${{ secrets.EC2_HOST }}"
          echo "‚úÖ EC2_USER: ${{ secrets.EC2_USER }}"
          echo "‚úÖ EC2_PORT: ${{ secrets.EC2_PORT || '22 (default)' }}"
          echo "‚úÖ SSH_PRIVATE_KEY: [Configured]"
        else
          echo "‚ùå Missing required secrets: ${MISSING_SECRETS[*]}"
          echo ""
          echo "üìù Quick Setup Instructions:"
          echo ""
          echo "### Method 1: GitHub CLI (Recommended)"
          echo "\`\`\`bash"
          echo "# Install GitHub CLI (if not installed)"
          echo "gh auth login"
          echo ""
          echo "# Add secrets"
          echo "gh secret set EC2_HOST --body '13.203.154.21'"
          echo "gh secret set EC2_USER --body 'ubuntu'"
          echo "gh secret set EC2_PORT --body '22'"
          echo "gh secret set SSH_PRIVATE_KEY < ~/your-key.pem"
          echo "\`\`\`"
          echo ""
          echo "### Method 2: GitHub Web UI"
          echo "1. Go to: Settings ‚Üí Secrets and variables ‚Üí Actions"
          echo "2. Click 'New repository secret'"
          echo "3. Add each secret:"
          echo "   - EC2_HOST: Your EC2 IP address"
          echo "   - EC2_USER: ubuntu (or your EC2 username)"
          echo "   - EC2_PORT: 22 (or your SSH port)"
          echo "   - SSH_PRIVATE_KEY: Complete content of your .pem file"
          echo ""
          echo "### Verify Secrets"
          echo "After adding, verify with: gh secret list"
          echo ""
          exit 1
        fi

  setup:
    needs: check-secrets
    if: github.event.inputs.setup_new == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: üêõ Debug - Setup Info
      run: |
        echo "üîç Setup Debug Info:"
        echo "EC2 Host: ${{ secrets.EC2_HOST }}"
        echo "EC2 User: ${{ secrets.EC2_USER }}"
        echo "EC2 Port: ${{ secrets.EC2_PORT || 22 }}"
        echo "Repo URL: ${{ secrets.REPO_URL || 'Not set' }}"
    
    - name: üîß Setup EC2 Instance (First Time)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        script: |
          set -e
          set -x  # Enable debug mode
          echo "üîß Setting up EC2 instance..."
          echo "üìã System Info:"
          uname -a
          whoami
          pwd
          
          # Install Docker
          if ! command -v docker &> /dev/null; then
            echo "üì¶ Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh 2>&1 | tee docker-install.log
            sudo usermod -aG docker ${{ secrets.EC2_USER }}
            echo "‚úÖ Docker installed"
            docker --version
          else
            echo "‚úÖ Docker already installed: $(docker --version)"
          fi
          
          # Install Docker Compose
          if ! command -v docker-compose &> /dev/null; then
            echo "üì¶ Installing Docker Compose..."
            sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            sudo chmod +x /usr/local/bin/docker-compose
            echo "‚úÖ Docker Compose installed"
            docker-compose --version
          else
            echo "‚úÖ Docker Compose already installed: $(docker-compose --version)"
          fi
          
          # Create directory
          echo "üìÅ Creating directories..."
          sudo mkdir -p /var/www/pharmacy-backend
          sudo chown ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /var/www/pharmacy-backend
          cd /var/www/pharmacy-backend
          echo "‚úÖ Directory created: $(pwd)"
          
          # Clone repo if not exists
          if [ ! -d ".git" ]; then
            echo "üì• Cloning repository..."
            git clone ${{ secrets.REPO_URL || 'https://github.com/YOUR_USERNAME/pharmacy-backend.git' }} . 2>&1 | tee clone.log
            echo "‚úÖ Repository cloned"
          else
            echo "‚úÖ Repository already exists"
            git remote -v
          fi
          
          # Setup .env
          if [ ! -f .env ]; then
            echo "‚öôÔ∏è  Setting up .env..."
            cp .env.example .env || echo "‚ö†Ô∏è .env.example not found"
            EC2_IP=${{ secrets.EC2_HOST }}
            sed -i "s|APP_URL=.*|APP_URL=http://$EC2_IP:8000|g" .env
            sed -i "s|APP_ENV=.*|APP_ENV=production|g" .env
            sed -i "s|APP_DEBUG=.*|APP_DEBUG=false|g" .env
            echo "‚úÖ .env file created"
            cat .env | grep -E "(APP_URL|APP_ENV|APP_DEBUG)" || echo "‚ö†Ô∏è .env check"
          else
            echo "‚úÖ .env file already exists"
          fi
          
          # Create network
          docker network create pharmacy-network || echo "‚ö†Ô∏è Network may already exist"
          docker network ls | grep pharmacy-network || echo "‚ö†Ô∏è Network check"
          
          echo "‚úÖ EC2 setup complete!"

  deploy:
    needs: [check-secrets, setup]
    if: always() && needs.check-secrets.result == 'success' && (needs.setup.result == 'success' || needs.setup.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4
    
    - name: üêõ Debug - Deployment Info
      run: |
        echo "üîç Deployment Debug Info:"
        echo "Branch: ${{ github.ref }}"
        echo "Commit: ${{ github.sha }}"
        echo "Author: ${{ github.actor }}"
        echo "EC2 Host: ${{ secrets.EC2_HOST }}"
    
    - name: üöÄ Deploy to EC2
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        script: |
          set -e
          set -x  # Enable debug mode
          echo "üöÄ Starting deployment..."
          echo "üìã Pre-deployment checks:"
          pwd
          whoami
          docker --version
          docker-compose --version
          
          # Ensure directory exists
          sudo mkdir -p /var/www/pharmacy-backend
          sudo chown ${{ secrets.EC2_USER }}:${{ secrets.EC2_USER }} /var/www/pharmacy-backend
          cd /var/www/pharmacy-backend
          echo "‚úÖ Working directory: $(pwd)"
          
          # Clone if not exists
          if [ ! -d ".git" ]; then
            echo "üì• Cloning repository..."
            git clone ${{ secrets.REPO_URL || 'https://github.com/YOUR_USERNAME/pharmacy-backend.git' }} .
          fi
          
          # Pull latest code
          echo "üì• Pulling latest code..."
          git fetch origin 2>&1 | tee fetch.log
          git reset --hard origin/main || git reset --hard origin/master
          echo "‚úÖ Code updated"
          git log -1 --oneline
          
          # Ensure .env exists
          if [ ! -f .env ]; then
            echo "‚ö†Ô∏è .env not found, creating..."
            cp .env.example .env || echo "‚ö†Ô∏è .env.example not found"
            EC2_IP=${{ secrets.EC2_HOST }}
            sed -i "s|APP_URL=.*|APP_URL=http://$EC2_IP:8000|g" .env
            sed -i "s|APP_ENV=.*|APP_ENV=production|g" .env
            sed -i "s|APP_DEBUG=.*|APP_DEBUG=false|g" .env
          fi
          echo "‚úÖ .env file ready"
          
          # Ensure network exists
          docker network create pharmacy-network || echo "‚ö†Ô∏è Network may already exist"
          docker network ls | grep pharmacy-network || echo "‚ö†Ô∏è Network check"
          
          # Stop existing containers
          echo "üõë Stopping existing containers..."
          docker-compose down 2>&1 | tee down.log || echo "‚ö†Ô∏è No containers to stop"
          docker ps -a | grep pharmacy || echo "‚úÖ No existing containers"
          
          # Deploy
          echo "üê≥ Building and starting containers..."
          docker-compose up -d --build 2>&1 | tee build.log
          echo "‚úÖ Containers started"
          
          # Check container status
          echo "üìä Container Status:"
          docker-compose ps
          sleep 5
          docker ps | grep pharmacy || echo "‚ö†Ô∏è Container check"
          
          # Wait for services
          echo "‚è≥ Waiting for services to start..."
          for i in {1..9}; do
            echo "   Check $i/9..."
            if docker-compose exec -T db mysqladmin ping -h localhost &>/dev/null; then
              echo "‚úÖ MySQL is ready"
              break
            fi
            sleep 5
          done
          
          # Laravel setup
          echo "‚öôÔ∏è  Setting up Laravel..."
          docker-compose exec -T app composer install --no-dev --optimize-autoloader 2>&1 | tee composer.log || echo "‚ö†Ô∏è Composer install"
          docker-compose exec -T app php artisan key:generate --force 2>&1 | tee keygen.log || echo "‚ö†Ô∏è Key generate"
          docker-compose exec -T app php artisan migrate --force 2>&1 | tee migrate.log || echo "‚ö†Ô∏è Migrate"
          docker-compose exec -T app php artisan db:seed --force 2>&1 | tee seed.log || echo "‚ö†Ô∏è Seed"
          docker-compose exec -T app php artisan config:cache 2>&1 | tee config-cache.log || echo "‚ö†Ô∏è Config cache"
          docker-compose exec -T app php artisan route:cache 2>&1 | tee route-cache.log || echo "‚ö†Ô∏è Route cache"
          docker-compose exec -T app php artisan view:cache 2>&1 | tee view-cache.log || echo "‚ö†Ô∏è View cache"
          
          echo "‚úÖ Deployment complete!"
          
          # Final status
          echo "üìä Final Status:"
          docker-compose ps
          docker-compose logs --tail=20 app || echo "‚ö†Ô∏è App logs"
          docker-compose logs --tail=20 nginx || echo "‚ö†Ô∏è Nginx logs"

    - name: üîç Health Check
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        script: |
          set -x
          echo "üîç Running health check..."
          cd /var/www/pharmacy-backend
          
          # Check containers
          echo "üìä Container Status:"
          docker-compose ps
          
          # Check logs
          echo "üìã Recent Logs:"
          docker-compose logs --tail=10 app || echo "‚ö†Ô∏è App logs"
          
          # Health check
          for i in {1..10}; do
            echo "   Health check attempt $i/10..."
            RESPONSE=$(curl -f -s http://localhost:8000/api/health || echo "FAILED")
            if [ "$RESPONSE" != "FAILED" ]; then
              echo "‚úÖ Health check passed!"
              echo "Response: $RESPONSE"
              exit 0
            fi
            echo "   Retry in 5 seconds..."
            sleep 5
          done
          
          echo "‚ùå Health check failed"
          echo "üìã Debug Info:"
          docker-compose ps
          docker-compose logs --tail=50 app
          docker-compose logs --tail=50 nginx
          exit 1

    - name: üîÑ Rollback on Failure
      if: failure()
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        script: |
          set -x
          echo "üîÑ Rolling back to previous version..."
          cd /var/www/pharmacy-backend
          
          echo "üìã Current status:"
          git log -1 --oneline
          docker-compose ps
          
          echo "üîÑ Rolling back..."
          git reset --hard HEAD~1 || echo "‚ö†Ô∏è Git reset"
          git log -1 --oneline
          
          echo "üê≥ Rebuilding..."
          docker-compose down || true
          docker-compose up -d --build 2>&1 | tee rollback-build.log
          
          sleep 30
          
          echo "‚úÖ Rollback complete"
          docker-compose ps
          curl -f http://localhost:8000/api/health || echo "‚ö†Ô∏è Health check after rollback"