name: ðŸ’¾ Automated Database Backup

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Backup Database
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ${{ secrets.EC2_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: ${{ secrets.EC2_PORT || 22 }}
        script: |
          set -e
          cd /var/www/pharmacy-backend
          
          BACKUP_DIR="/var/backups/pharmacy"
          mkdir -p $BACKUP_DIR
          
          BACKUP_FILE="$BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S).sql"
          
          echo "ðŸ’¾ Creating database backup..."
          docker-compose exec -T db mysqldump -u pharmacy_user -proot pharmacy_db > $BACKUP_FILE
          
          # Compress backup
          gzip $BACKUP_FILE
          
          # Keep only last 7 days of backups
          find $BACKUP_DIR -name "backup-*.sql.gz" -mtime +7 -delete
          
          echo "âœ… Backup created: $BACKUP_FILE.gz"
          
          # List backups
          echo "ðŸ“¦ Available backups:"
          ls -lh $BACKUP_DIR/
